{
  "appInfo": {
    "appName": "",
    "appType": "desktop-webview",
    "appDesc": "create desktop webview using zfcore as server and https://github.com/zserge/webview as webkit engine."
  },
  "nimble": [
    "install zip@#head",
    "install uri3@#head",
    "install zfblast@#head",
    "install zfcore@#head",
    "install zfplugs@#head",
    "install stdext@#head",
    "install karax@#head",
    "install webview@#head"
  ],
  "initVar": {
    "appDir": "{appsDir}::{appName}",
    "srcDir": "{appDir}::src",
    "srcServerDir": "{appDir}::src::server",
    "srcSpaDir": "{appDir}::src::client",
    "srcWebviewDir": "{appDir}::src::webview",
    "wwwDir": "{appDir}::www",
    "compiledJsDir": "{wwwDir}::private::js::compiled"
  },
  "init": [
    {
      "action": "copyDir",
      "list": [
        {
          "src": "{templatesDir}::{appType}",
          "dest": "{appDir}",
          "next": [
            {
              "action": "copyFile",
              "list": [
                {
                  "src": "nakefile.nim",
                  "dest": "{appDir}::nakefile.nim",
                  "next": [
                    {
                      "action": "moveFile",
                      "list": [
                        {
                          "src": "{srcDir}::app.nim",
                          "dest": "{srcDir}::{appName}.nim",
                          "next": [
                            {
                              "action": "replaceStr",
                              "file": "{srcDir}::{appName}.nim",
                              "list": [
                                {
                                  "old": "appName",
                                  "new": "{appName}"
                                }
                              ]
                            },
                            {
                              "action": "moveDir",
                              "list": [
                                {
                                  "src": "{srcServerDir}::app.nim",
                                  "dest": "{srcServerDir}::{appName}.nim"
                                },
                                {
                                  "src": "{srcSpaDir}::app.nim",
                                  "dest": "{srcSpaDir}::{appName}.nim",
                                  "next": [
                                    {
                                      "action": "createDir",
                                      "list": [
                                        {"name": "{compiledJsDir}"}
                                      ]
                                    },
                                    {
                                      "action": "cmd",
                                      "exe": "nimble install karax"
                                    },
                                    {
                                      "action": "cmd",
                                      "exe": "karun",
                                      "props": {
                                        "src": "{srcSpaDir}::{appName}.nim"
                                      },
                                      "options": "{src}"
                                    },
                                    {
                                      "action": "moveFile",
                                      "list": [
                                        {
                                          "src": "{appName}.html",
                                          "dest": "{wwwDir}::index.html"
                                        },
                                        {
                                          "src": "{appName}.js",
                                          "dest": "{compiledJsDir}::{appName}.js"
                                        }
                                      ]
                                    },
                                    {
                                      "action": "replaceStr",
                                      "file": "{wwwDir}::index.html",
                                      "list": [
                                        {
                                          "old": "{appName}.js",
                                          "new": "/private/js/compiled/{appName}.js"
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "src": "{srcWebviewDir}::app.nim",
                                  "dest": "{srcWebviewDir}::{appName}.nim",
                                  "next": [
                                    {
                                      "action": "replaceStr",
                                      "file": "{srcWebviewDir}::{appName}.nim",
                                      "list": [
                                        {
                                          "old": "appName",
                                          "new": "{appName}"
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
  ],
  "compile-client": {
    "desc": "compile client app only.",
    "tasks": [
      {
        "action": "cmd",
        "exe" : "nim",
        "props": {
          "src": "{currentAppDir}::src::client::{appName}.nim",
          "out": "{currentAppDir}::www::private::js::compiled"
        },
        "options": "js --outdir:{out} {src}"
      }
    ]
  },
  "compile-debug-client": {
    "desc": "compile debug client app only.",
    "tasks": [
      {
        "action": "cmd",
        "exe" : "nake",
        "options": "compile-client {appName}",
        "next": [
          {
            "action": "copyDir",
            "list": [
              {
                "src": "{currentAppDir}::www::private::js::compiled",
                "dest": "{currentAppDir}::bin::debug::www::private::js::compiled"
              }
            ]
          }
        ]
      }
    ]
  },
  "compile-release-client": {
    "desc": "compile release client app only.",
    "tasks": [
      {
        "action": "cmd",
        "exe" : "nake",
        "options": "compile-client {appName}",
        "next": [
          {
            "action": "copyDir",
            "list": [
              {
                "src": "{currentAppDir}::www::private::js::compiled",
                "dest": "{currentAppDir}::bin::release::www::private::js::compiled"
              }
            ]
          }
        ]
      }
    ]
  },
  "compile-release-server": {
    "desc": "compile release server app only",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nim",
        "props": {
          "src": "{currentAppDir}::src::server::{appName}.nim",
          "out": "{currentAppDir}::bin::release::{appName}_srv"
        },
        "options": "c -d:nimDebugDlOpen -d:ssl -d:zlib -d:release --threads:on --out:{out} {src}",
        "next": [
          {
            "action": "cmd",
            "exe": "nim",
            "props": {
              "src": "{currentAppDir}::src::webview::{appName}.nim",
              "out": "{currentAppDir}::bin::release::{appName}_wv"
            },
            "options": "c -d:nimDebugDlOpen -d:ssl -d:zlib -d:release --threads:on --out:{out} {src}"
          }
        ]
      }
    ]
  },
  "compile-debug-server": {
    "desc": "compile debug server app only",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nim",
        "props": {
          "src": "{currentAppDir}::src::server::{appName}.nim",
          "out": "{currentAppDir}::bin::debug::{appName}_srv"
        },
        "options": "c -d:nimDebugDlOpen -d:ssl -d:zlib --threads:on --out:{out} {src}",
        "next": [
          {
            "action": "cmd",
            "exe": "nim",
            "props": {
              "src": "{currentAppDir}::src::webview::{appName}.nim",
              "out": "{currentAppDir}::bin::debug::{appName}_wv"
            },
            "options": "c -d:nimDebugDlOpen -d:ssl -d:zlib --threads:on --out:{out} {src}"
          }
        ]
      }
    ]
  },
  "debug": {
    "desc": "debug the app.",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nake",
        "options": "compile-debug-server {appName}",
        "next": [
          {
            "action": "cmd",
            "exe" : "nake",
            "options": "compile-client {appName}",
            "next": [
              {
                "action": "copyDir",
                "list": [
                  {
                    "src": "{currentAppDir}::www",
                    "dest": "{currentAppDir}::bin::debug::www"
                  }
                ]
              },
              {
                "action": "copyFile",
                "list": [
                  {
                    "src": "{currentAppDir}::settings.json",
                    "dest": "{currentAppDir}::bin::debug::settings.json",
                    "err": []
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "debug-run": {
    "desc": "debug the app then run it.",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nim",
        "props": {
          "src": "{currentAppDir}::src::{appName}.nim",
          "out": "{currentAppDir}::bin::debug"
        },
        "options": "c -d:nimDebugDlOpen -d:ssl -d:zlib --threads:on --outdir:{out} {src}",
        "next": [
          {
            "action": "cmd",
            "exe": "nake",
            "options": "debug {appName}",
            "next": [
              {
                "action": "cmd",
                "exe": "{currentAppDir}::bin::debug::{appName}",
                "onPlatform": {
                  "windows": {
                    "exe": "{currentAppDir}::bin::debug::{appName}.exe"
                  }
                }
              }
            ]
          }
        ]
      }
    ]
  },
  "release": {
    "desc": "release the app.",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nake",
        "options": "compile-release-server {appName}",
        "next": [
          {
            "action": "cmd",
            "exe" : "nake",
            "options": "compile-client {appName}",
            "next": [
              {
                "action": "copyDir",
                "list": [
                  {
                    "src": "{currentAppDir}::www",
                    "dest": "{currentAppDir}::bin::release::www"
                  }
                ]
              },
              {
                "action": "copyFile",
                "list": [
                  {
                    "src": "{currentAppDir}::settings.json",
                    "dest": "{currentAppDir}::bin::release::settings.json",
                    "err": []
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "release-run": {
    "desc": "release the app then run it.",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nim",
        "props": {
          "src": "{currentAppDir}::src::{appName}.nim",
          "out": "{currentAppDir}::bin::debug"
        },
        "options": "c -d:nimDebugDlOpen -d:ssl -d:release -d:zlib --threads:on --outdir:{out} {src}",
        "next": [
          {
            "action": "cmd",
            "exe": "nake",
            "options": "release {appName}",
            "next": [
              {
                "action": "cmd",
                "exe": "{currentAppDir}::bin::release::{appName}",
                "onPlatform": {
                  "windows": {
                    "exe": "{currentAppDir}::bin::release::{appName}.exe"
                  }
                }
              }
            ]
          }
        ]
      }
    ]
  },
  "clean-release-run": {
    "desc": "clean release then run the app.",
    "tasks": [
      {
        "action": "removeDir",
        "list":[
          {
            "name": "{currentAppDir}::bin::release",
            "next": [
              {
                "action": "cmd",
                "exe": "nake",
                "options": "release-run {appName}"
              }
            ]
          }
        ]
      }
    ]
  },
  "clean-debug-run": {
    "desc": "clean debug then run the app.",
    "tasks": [
      {
        "action": "removeDir",
        "list":[
          {
            "name": "{currentAppDir}::bin::debug",
            "next": [
              {
                "action": "cmd",
                "exe": "nake",
                "options": "debug-run {appName}"
              }
            ]
          }
        ]
      }
    ]
  },
  "clean-all": {
    "desc": "clean bin dir.",
    "tasks": [
      {
        "action": "removeDir",
        "list": [
          {"name": "{currentAppDir}::bin"}
        ]
      }
    ]
  },
  "watch-debug-run": {
    "desc": "watch changes in debug mode then run.",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nake",
        "options": "debug {appName}",
        "next": [
          {
            "action": "cmd",
            "exe": "{currentAppDir}::bin::debug::{appName} &",
            "onPlatform": {
              "windows": {
                "exe": "start {currentAppDir}::bin::debug::{appName}.exe"
              }
            },
            "next": [
              {
                "action": "watch",
                "list": [
                  {
                    "dir": "{currentAppDir}::src::client",
                    "pattern": "[\\w\\W]*\\.nim",
                    "onModified": [
                      {
                        "action": "cmd",
                        "exe": "nake",
                        "options": "compile-debug-client {appName}"
                      }
                    ]
                  },
                  {
                    "dir": "{currentAppDir}::src::server",
                    "pattern": "[\\w\\W]*\\.nim",
                    "onModified": [
                      {
                        "action": "cmd",
                        "exe": "killall {appName}_srv",
                        "onPlatform": {
                          "windows": {
                            "exe": "taskkill /IM \"{appName}_srv.exe\" /F"
                          }
                        },
                        "err": []
                      },
                      {
                        "action": "cmd",
                        "exe": "nake",
                        "options": "compile-debug-server {appName}",
                        "next": [
                          {
                            "action": "cmd",
                            "exe": "{currentAppDir}::bin::debug::{appName}_srv &",
                            "onPlatform": {
                              "windows": {
                                "exe": "start {currentAppDir}::bin::debug::{appName}_srv.exe"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "dir": "{currentAppDir}::www",
                    "pattern": "[\\w\\W]+$",
                    "onModified": [
                      {
                        "action": "copyDir",
                        "list": [
                          {
                            "src": "{currentAppDir}::www",
                            "dest": "{currentAppDir}::bin::debug::www"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  },
  "watch-release-run": {
    "desc": "watch changes in release mode then run.",
    "tasks": [
      {
        "action": "cmd",
        "exe": "nake",
        "options": "release {appName}",
        "next": [
          {
            "action": "cmd",
            "exe": "{currentAppDir}::bin::release::{appName} &",
            "onPlatform": {
              "windows": {
                "exe": "start {currentAppDir}::bin::release::{appName}.exe"
              }
            },
            "next": [
              {
                "action": "watch",
                "list": [
                  {
                    "dir": "{currentAppDir}::src::client",
                    "pattern": "[\\w\\W]*\\.nim",
                    "onModified": [
                      {
                        "action": "cmd",
                        "exe": "nake",
                        "options": "compile-release-client {appName}"
                      }
                    ]
                  },
                  {
                    "dir": "{currentAppDir}::src::server",
                    "pattern": "[\\w\\W]*\\.nim",
                    "onModified": [
                      {
                        "action": "cmd",
                        "exe": "killall {appName}_srv",
                        "onPlatform": {
                          "windows": {
                            "exe": "taskkill /IM \"{appName}_srv.exe\" /F"
                          }
                        },
                        "err": []
                      },
                      {
                        "action": "cmd",
                        "exe": "nake",
                        "options": "compile-release-server {appName}",
                        "next": [
                          {
                            "action": "cmd",
                            "exe": "{currentAppDir}::bin::release::{appName}_srv &",
                            "onPlatform": {
                              "windows": {
                                "exe": "start {currentAppDir}::bin::release::{appName}_srv.exe"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  },
                  {
                    "dir": "{currentAppDir}::www",
                    "pattern": "[\\w\\W]+$",
                    "onModified": [
                      {
                        "action": "copyDir",
                        "list": [
                          {
                            "src": "{currentAppDir}::www",
                            "dest": "{currentAppDir}::bin::release::www"
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    ]
  }
}
